#!/usr/bin/env node

const {dirname} = require('path')

const services = require('../../src/services.js')
const {normalize} = require('../../src/config.js')

async function main (services) {
  const {build, fileSystem: {withTempDir}, readConfig, screenshotManager: {run}} = services
  const [,, configPath, outputPath] = process.argv

  if (!configPath || !outputPath) throw new Error('Usage: run <config-path> <output-path>')

  const config = normalize(await readConfig(configPath))
  const userInputDir = dirname(configPath)

  await withTempDir(async tempPath => {
    const options = {configPath, outputPath, tempPath, userInputDir}

    await run(build.bind(null, config, options))
  })
}

const {exit, logger} = services

main(services).catch(({stack}) => {
  logger.error(stack)
  exit(1)
})
